<!DOCTYPE html>
<html lang=\"es\">
<head>
<meta charset=\"UTF-8\" />
<title>Visor de planes del aeropuerto</title>
<style>
body {
  font-family: 'Segoe UI', sans-serif;
  background: #f7f8fb;
  color: #222;
  margin: 0;
  padding: 0;
}
header {
  background: linear-gradient(120deg, #243c64, #1d2e4f);
  color: white;
  padding: 16px 24px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.15);
}
main {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 16px;
  padding: 16px;
}
svg {
  width: 100%;
  height: 660px;
  background: #fdfefe;
  border: 1px solid #d6d9e1;
  border-radius: 12px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.08);
}
.file-loader {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 10px;
  margin-top: 8px;
  background: #fff;
  border: 1px solid #d6d9e1;
  border-radius: 8px;
  padding: 10px 12px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.04);
}
.file-loader label {
  display: flex;
  flex-direction: column;
  font-size: 13px;
  color: #1b2738;
  gap: 4px;
}
.file-loader small {
  color: #52607a;
}
.file-loader input, .file-loader select {
  padding: 6px 8px;
  border-radius: 6px;
  border: 1px solid #cfd6e3;
  font-size: 13px;
}
.file-loader button {
  background: #243c64;
  color: #fff;
  border: none;
  border-radius: 6px;
  padding: 8px 10px;
  cursor: pointer;
}
.node {
  fill: #e8edf6;
  stroke: #243c64;
  stroke-width: 2;
}
.node-label {
  font-size: 12px;
  fill: #1b2738;
  font-weight: 600;
}
.road {
  stroke: #9aaac7;
  stroke-width: 10;
  stroke-linecap: round;
  opacity: 0.9;
}
.road-dash {
  stroke: #fdfefe;
  stroke-width: 3;
  stroke-linecap: round;
  stroke-dasharray: 14 10;
  opacity: 0.9;
}
#panel {
  background: #fff;
  border: 1px solid #d6d9e1;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  padding: 12px 16px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.controls button {
  background: #243c64;
  color: white;
  border: none;
  border-radius: 4px;
  padding: 8px 12px;
  cursor: pointer;
}
.controls button:disabled {
  background: #a7b4c9;
  cursor: not-allowed;
}
.export-controls {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 10px;
  align-items: center;
  background: #fff;
  border: 1px solid #d6d9e1;
  border-radius: 8px;
  padding: 10px 12px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.04);
}
.export-controls label {
  font-size: 12px;
  color: #1b2738;
  display: block;
  margin-bottom: 4px;
}
.export-controls select {
  width: 100%;
  padding: 6px 8px;
  border-radius: 6px;
  border: 1px solid #cfd6e3;
  font-size: 13px;
}
.export-actions {
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.export-actions button {
  background: #1d7c4d;
  color: #fff;
  border: none;
  border-radius: 6px;
  padding: 8px 12px;
  cursor: pointer;
}
.export-actions button:disabled {
  background: #9dcab2;
  cursor: not-allowed;
}
.export-actions small {
  color: #243c64;
}
.action-log {
  max-height: 360px;
  overflow-y: auto;
  border: 1px solid #e0e4ec;
  border-radius: 6px;
}
.action-log ul {
  list-style: none;
  padding: 0;
  margin: 0;
}
.action-log li {
  padding: 8px 10px;
  border-bottom: 1px solid #eef1f6;
}
.action-log li.active {
  background: #e9f2ff;
  border-left: 4px solid #4a90e2;
}
.badge {
  display: inline-block;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 11px;
  margin-right: 6px;
  font-weight: 700;
}
.badge.machine { background: #f6c34433; color: #b58100; }
.badge.vagon { background: #71c4e833; color: #1c7395; }
.badge.equipaje { background: #67d49a33; color: #2b8c5c; }
.badge.suspicious { background: #f17d7d33; color: #b12222; }
.legend { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
.legend span { font-size: 12px; }
.entity-label {
  font-size: 10px;
  fill: #1b2738;
  font-weight: 700;
}
.connection-line { stroke: #8ea1c7; stroke-dasharray: 5 3; stroke-width: 2; }
.machine-body { fill: #f6c344; stroke: #243c64; stroke-width: 1.8; }
.machine-cabin { fill: #ffe08a; stroke: #243c64; stroke-width: 1.4; }
.wagon-body { fill: #71c4e8; stroke: #1b2738; stroke-width: 1.8; }
.wagon-top { fill: #9dd8f3; stroke: #1b2738; stroke-width: 1.4; }
.wheel { fill: #1b2738; }
.bag { stroke: #1b2738; stroke-width: 1.5; }
.bag.normal .bag-body { fill: #67d49a; }
.bag.suspicious .bag-body { fill: #ff4d4f; }
.bag.checked .bag-body { filter: brightness(1.05); }
.bag-handle { fill: none; stroke: #1b2738; stroke-width: 1.5; }
.literal-panel {
  border: 1px solid #e0e4ec;
  border-radius: 6px;
  padding: 10px;
  background: #fff;
}
.literal-panel h3 { margin: 0 0 6px 0; color: #243c64; }
.literal-list { list-style: none; padding: 0; margin: 0; max-height: 180px; overflow-y: auto; }
.literal-list li { padding: 4px 0; border-bottom: 1px solid #f0f3f8; font-size: 13px; }
.literal-added { color: #0b8b3d; font-weight: 600; }
.literal-removed { color: #c1272d; font-weight: 600; }
</style>
</head>
<body>
<header>
  <h1>Visor de soluciones PDDL — Aeropuerto</h1>
  <p>Plan: plan_optic.sol | Problema: problem.pddl</p>
</header>
<main>
  <div>
    <svg id="map" viewBox="0 0 1040 660" aria-label="Plano del aeropuerto"></svg>
  </div>
  <div id="panel">
    <div class="file-loader" aria-label="Selector de soluciones">
      <label>
        Carpeta con soluciones
        <input type="file" id="folderInput" webkitdirectory multiple>
        <small>Se detectarán automáticamente los ficheros de plan (.sol, .soln)</small>
      </label>
      <label>
        Problema PDDL
        <input type="file" id="problemInput" accept=".pddl">
      </label>
      <label>
        Plan individual
        <input type="file" id="planInput" accept=".sol,.SOL,.soln,.plan,.txt">
      </label>
      <label>
        Plan seleccionado
        <select id="planSelect"></select>
      </label>
      <div>
        <button id="useLoaded">Usar plan seleccionado</button>
      </div>
    </div>
    <div class="controls">
      <button id="back">⏮️ Atrás</button>
      <button id="play">▶️ Reproducir</button>
      <button id="next">⏭️ Siguiente</button>
      <span id="status"></span>
    </div>
    <div class="export-controls" aria-label="Exportar recorrido como GIF">
      <div>
        <label for="gifStart">Desde</label>
        <select id="gifStart"></select>
      </div>
      <div>
        <label for="gifEnd">Hasta</label>
        <select id="gifEnd"></select>
      </div>
      <div class="export-actions">
        <button id="downloadGif">Descargar GIF</button>
        <small id="gifStatus"></small>
      </div>
    </div>
    <div class="legend">
      <span class="badge machine">M</span><span>Máquina</span>
      <span class="badge vagon">V</span><span>Vagón</span>
      <span class="badge equipaje">E</span><span>Equipaje</span>
      <span class="badge suspicious">S</span><span>Equipaje sospechoso</span>
    </div>
    <div class="literal-panel" aria-label="Literales tras la acción">
      <h3>Literales verdaderos</h3>
      <ul id="literalList" class="literal-list"></ul>
      <h4>Cambios de esta acción</h4>
      <ul id="literalChanges" class="literal-list"></ul>
    </div>
    <div class="action-log" aria-label="Secuencia de acciones">
      <ul id="log"></ul>
    </div>
  </div>
</main>
<script src="https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.js"></script>
<script>
const nodes = {
  facturacion: { x: 150, y: 140, label: 'Zona de facturación' },
  inspeccion: { x: 520, y: 180, label: 'Oficina de inspección' },
  recogida: { x: 890, y: 140, label: 'Recogida de equipajes' },
  puerta1: { x: 160, y: 520, label: 'Puerta1' },
  puerta2: { x: 300, y: 300, label: 'Puerta2' },
  puerta3: { x: 320, y: 520, label: 'Puerta3' },
  puerta4: { x: 210, y: 380, label: 'Puerta4' },
  puerta5: { x: 890, y: 520, label: 'Puerta5' },
  puerta6: { x: 740, y: 300, label: 'Puerta6' },
  puerta7: { x: 720, y: 520, label: 'Puerta7' },
  puerta8: { x: 830, y: 380, label: 'Puerta8' }
};

const edges = [
  ['facturacion','inspeccion'],['recogida','inspeccion'],['facturacion','recogida'],
  ['facturacion','puerta2'],['recogida','puerta6'],['inspeccion','puerta1'],['inspeccion','puerta5'],
  ['puerta2','puerta4'],['puerta4','puerta3'],['puerta3','puerta1'],
  ['puerta6','puerta8'],['puerta8','puerta7'],['puerta7','puerta5'],
  ['facturacion','puerta3'],['recogida','puerta7']
];

const payload = {"planFile": "plan_optic.sol", "problemFile": "problem.pddl", "planText": "Number of literals: 243\nConstructing lookup tables: [10%] [20%] [30%] [40%] [50%] [60%] [70%] [80%] [90%] [100%]\nPost filtering unreachable actions:  [10%] [20%] [30%] [40%] [50%] [60%] [70%] [80%] [90%] [100%]\n\u001b[01;34mNo analytic limits found, not considering limit effects of goal-only operators\u001b[00m\nAction 3462 - (inspeccionar-equipaje e3 inspeccion v1 m1) is uninteresting once we have fact (normal e3)\nAction 3463 - (inspeccionar-equipaje e6 inspeccion v1 m1) is uninteresting once we have fact (normal e6)\nAction 3464 - (inspeccionar-equipaje e3 inspeccion v2 m1) is uninteresting once we have fact (normal e3)\nAction 3465 - (inspeccionar-equipaje e6 inspeccion v2 m1) is uninteresting once we have fact (normal e6)\nAction 3466 - (inspeccionar-equipaje e3 inspeccion v3 m1) is uninteresting once we have fact (normal e3)\nAction 3467 - (inspeccionar-equipaje e6 inspeccion v3 m1) is uninteresting once we have fact (normal e6)\nAction 3468 - (inspeccionar-equipaje e3 inspeccion v4 m1) is uninteresting once we have fact (normal e3)\nAction 3469 - (inspeccionar-equipaje e6 inspeccion v4 m1) is uninteresting once we have fact (normal e6)\nAction 3470 - (inspeccionar-equipaje e3 inspeccion v5 m1) is uninteresting once we have fact (normal e3)\nAction 3471 - (inspeccionar-equipaje e6 inspeccion v5 m1) is uninteresting once we have fact (normal e6)\nAction 3472 - (inspeccionar-equipaje e3 inspeccion v1 m2) is uninteresting once we have fact (normal e3)\nAction 3473 - (inspeccionar-equipaje e6 inspeccion v1 m2) is uninteresting once we have fact (normal e6)\nAction 3474 - (inspeccionar-equipaje e3 inspeccion v2 m2) is uninteresting once we have fact (normal e3)\nAction 3475 - (inspeccionar-equipaje e6 inspeccion v2 m2) is uninteresting once we have fact (normal e6)\nAction 3476 - (inspeccionar-equipaje e3 inspeccion v3 m2) is uninteresting once we have fact (normal e3)\nAction 3477 - (inspeccionar-equipaje e6 inspeccion v3 m2) is uninteresting once we have fact (normal e6)\nAction 3478 - (inspeccionar-equipaje e3 inspeccion v4 m2) is uninteresting once we have fact (normal e3)\nAction 3479 - (inspeccionar-equipaje e6 inspeccion v4 m2) is uninteresting once we have fact (normal e6)\nAction 3480 - (inspeccionar-equipaje e3 inspeccion v5 m2) is uninteresting once we have fact (normal e3)\nAction 3481 - (inspeccionar-equipaje e6 inspeccion v5 m2) is uninteresting once we have fact (normal e6)\nInitial heuristic = 22.000, admissible cost estimate 0.000\nb (21.000 | 0.004)b (20.000 | 0.008)b (19.000 | 0.009)b (18.000 | 0.013)b (16.000 | 0.014)b (15.000 | 0.017)b (14.000 | 0.018)b (13.000 | 0.019)b (12.000 | 0.019)b (11.000 | 0.021)b (10.000 | 0.021)b (9.000 | 0.023)b (8.000 | 0.023)b (7.000 | 0.023)b (6.000 | 0.024)b (5.000 | 0.025)b (4.000 | 0.026)b (3.000 | 0.026)b (2.000 | 0.026)b (1.000 | 0.027)(G)\n; No metric specified - using makespan\n\n; Plan found with metric 0.028\n; States evaluated so far: 1180\n; States pruned based on pre-heuristic cost lower bound: 0\n; Time 1.04\n0.000: (mover-maquina m1 recogida facturacion)  [0.001]\n0.000: (mover-maquina m2 recogida inspeccion)  [0.001]\n0.001: (mover-maquina m1 facturacion puerta2)  [0.001]\n0.001: (mover-maquina m2 inspeccion puerta1)  [0.001]\n0.002: (enganchar-vagon v1 m2 puerta1 n0)  [0.001]\n0.002: (mover-maquina m1 puerta2 puerta4)  [0.001]\n0.003: (mover-maquina m2 puerta1 inspeccion)  [0.001]\n0.003: (mover-maquina m1 puerta4 puerta3)  [0.001]\n0.004: (desenganchar-vagon v1 m2 inspeccion n0)  [0.001]\n0.004: (mover-maquina m1 puerta3 puerta1)  [0.001]\n0.005: (mover-maquina m2 inspeccion puerta5)  [0.001]\n0.005: (enganchar-vagon v2 m1 puerta1 n0)  [0.001]\n0.006: (mover-maquina m1 puerta1 inspeccion)  [0.001]\n0.006: (mover-maquina m2 puerta5 puerta7)  [0.001]\n0.007: (mover-maquina m1 inspeccion facturacion)  [0.001]\n0.007: (mover-maquina m2 puerta7 puerta8)  [0.001]\n0.008: (cargar-equipaje e2 v2 m1 facturacion n0 n1)  [0.001]\n0.008: (mover-maquina m2 puerta8 puerta6)  [0.001]\n0.009: (cargar-equipaje e1 v2 m1 facturacion n1 n2)  [0.001]\n0.009: (mover-maquina m2 puerta6 recogida)  [0.001]\n0.010: (mover-maquina m1 facturacion puerta2)  [0.001]\n0.010: (mover-maquina m2 recogida inspeccion)  [0.001]\n0.011: (descargar-normal e2 v2 m1 puerta2 n2 n1)  [0.001]\n0.011: (enganchar-vagon v1 m2 inspeccion n0)  [0.001]\n0.012: (mover-maquina m1 puerta2 puerta4)  [0.001]\n0.012: (mover-maquina m2 inspeccion facturacion)  [0.001]\n0.013: (descargar-normal e1 v2 m1 puerta4 n1 n0)  [0.001]\n0.013: (mover-maquina m2 facturacion puerta2)  [0.001]\n0.014: (cargar-equipaje e6 v1 m2 puerta2 n0 n1)  [0.001]\n0.014: (mover-maquina m1 puerta4 puerta2)  [0.001]\n0.015: (cargar-equipaje e2 v1 m2 puerta2 n1 n2)  [0.001]\n0.015: (cargar-equipaje e5 v2 m1 puerta2 n0 n1)  [0.001]\n0.016: (mover-maquina m1 puerta2 facturacion)  [0.001]\n0.016: (mover-maquina m2 puerta2 facturacion)  [0.001]\n0.017: (mover-maquina m1 facturacion recogida)  [0.001]\n0.017: (mover-maquina m2 facturacion recogida)  [0.001]\n0.018: (descargar-normal e5 v2 m1 recogida n1 n0)  [0.001]\n0.018: (descargar-normal e2 v1 m2 recogida n2 n1)  [0.001]\n0.019: (mover-maquina m1 recogida inspeccion)  [0.001]\n0.019: (mover-maquina m2 recogida puerta6)  [0.001]\n0.020: (mover-maquina m1 inspeccion recogida)  [0.001]\n0.020: (cargar-equipaje e3 v1 m2 puerta6 n1 n2)  [0.001]\n0.021: (mover-maquina m2 puerta6 recogida)  [0.001]\n0.021: (cargar-equipaje e2 v2 m1 recogida n0 n1)  [0.001]\n0.022: (mover-maquina m1 recogida puerta6)  [0.001]\n0.022: (mover-maquina m2 recogida inspeccion)  [0.001]\n0.023: (cargar-equipaje e4 v2 m1 puerta6 n1 n2)  [0.001]\n0.023: (inspeccionar-equipaje e6 inspeccion v1 m2)  [0.001]\n0.023: (inspeccionar-equipaje e3 inspeccion v1 m2)  [0.001]\n0.024: (mover-maquina m2 inspeccion recogida)  [0.001]\n0.024: (mover-maquina m1 puerta6 puerta8)  [0.001]\n0.025: (descargar-normal e6 v1 m2 recogida n2 n1)  [0.001]\n0.025: (descargar-normal e2 v2 m1 puerta8 n2 n1)  [0.001]\n0.026: (mover-maquina m1 puerta8 puerta6)  [0.001]\n0.026: (descargar-normal e3 v1 m2 recogida n1 n0)  [0.001]\n0.027: (mover-maquina m1 puerta6 recogida)  [0.001]\n0.028: (descargar-normal e4 v2 m1 recogida n1 n0)  [0.001]\n\n * All goal deadlines now no later than 0.028\n\nResorting to best-first search\nRunning WA* with W = 5.000, not restarting with goal states\nb (21.000 | 0.004)b (20.000 | 0.007)b (19.000 | 0.008)b (17.000 | 0.011)b (16.000 | 0.012)b (15.000 | 0.014)b (14.000 | 0.015)b (13.000 | 0.016)b (12.000 | 0.019)b (11.000 | 0.020)b (10.000 | 0.023)b (9.000 | 0.026)b (8.000 | 0.027)b (7.000 | 0.028)b (7.000 | 0.027)b (6.000 | 0.027)b (5.000 | 0.027)b (5.000 | 0.026)b (4.000 | 0.027)b (3.000 | 0.028)b (3.000 | 0.027)b (2.000 | 0.027)b (1.000 | 0.027)(G)b (0.000 | 0.028)(G)(G)(G)(G)(G)(G)(G)(G)(G)(G)(G)(G)(G)(G)(G)(G)(G)(G)(G)(G)(G)(G)(G)(G)(G)(G)(G)(G)(G)(G)(G)", "problemText": "(define (problem aeropuerto-p1)\n  (:domain aeropuerto)\n\n  (:objects\n    ; ubicaciones\n    facturacion recogida inspeccion\n    puerta1 puerta2 puerta3 puerta4\n    puerta5 puerta6 puerta7 puerta8 - ubicacion\n\n    ; maquinas\n    m1 m2 - maquina\n\n    ; vagones\n    v1 v2 v3 v4 v5 - vagon\n\n    ; equipajes\n    e1 e2 e3 e4 e5 e6 - equipaje\n\n    ; niveles de carga\n    n0 n1 n2 - nivel   \n  )\n\n  (:init\n    ; ---------- Estructura de la terminal ----------\n    ; zona com\u00fan\n    (siguiente facturacion recogida)\n    (siguiente recogida facturacion)\n\n    (siguiente facturacion inspeccion)\n    (siguiente inspeccion facturacion)\n\n    (siguiente recogida inspeccion)\n    (siguiente inspeccion recogida)\n\n    ; conexiones con puertas\n    (siguiente facturacion puerta2)\n    (siguiente puerta2 facturacion)\n\n    (siguiente recogida puerta6)\n    (siguiente puerta6 recogida)\n\n    (siguiente inspeccion puerta1)\n    (siguiente puerta1 inspeccion)\n\n    (siguiente inspeccion puerta5)\n    (siguiente puerta5 inspeccion)\n\n    ; pasillo izquierdo: puertas contiguas 2\u20134\u20133\u20131\n    (siguiente puerta2 puerta4)\n    (siguiente puerta4 puerta2)\n\n    (siguiente puerta4 puerta3)\n    (siguiente puerta3 puerta4)\n\n    (siguiente puerta3 puerta1)\n    (siguiente puerta1 puerta3)\n\n    ; pasillo derecho: puertas contiguas 6\u20138\u20137\u20135\n    (siguiente puerta6 puerta8)\n    (siguiente puerta8 puerta6)\n\n    (siguiente puerta8 puerta7)\n    (siguiente puerta7 puerta8)\n\n    (siguiente puerta7 puerta5)\n    (siguiente puerta5 puerta7)\n\n    ; Oficina de inspecci\u00f3n\n    (es-oficina-inspeccion inspeccion)\n\n\n    ; Niveles\n    (siguiente-nivel n0 n1)\n    (siguiente-nivel n1 n2)\n    (nivel-cero n0)\n\n    ; ---------- Veh\u00edculos ----------\n    ; tres vagones sueltos en puerta1\n    (esta-en v1 puerta1)\n    (esta-en v2 puerta1)\n    (esta-en v3 puerta1)\n\n    ; dos vagones sueltos en puerta5\n    (esta-en v4 puerta5)\n    (esta-en v5 puerta5)\n\n    ; todos los vagones empiezan libres y vac\u00edos (n0)\n    (vagon-suelto v1)\n    (vagon-suelto v2)\n    (vagon-suelto v3)\n    (vagon-suelto v4)\n    (vagon-suelto v5)\n\n    (en-nivel v1 n0)\n    (en-nivel v2 n0)\n    (en-nivel v3 n0)\n    (en-nivel v4 n0)\n    (en-nivel v5 n0)\n\n\n    (libre m1)\n    (libre m2)\n\n    ; dos m\u00e1quinas en la zona de recogida\n    (esta-en m1 recogida)\n    (esta-en m2 recogida)\n\n    ; ---------- Equipajes ----------\n    ; 1) no sospechoso facturado \u2192 puerta4\n    (esta-en e1 facturacion)\n    (normal e1)\n\n    ; 2) no sospechoso facturado \u2192 puerta8\n    (esta-en e2 facturacion)\n    (normal e2)\n\n    ; 3) sospechoso llega a puerta6 \u2192 recogida (pasando por inspecci\u00f3n)\n    (esta-en e3 puerta6)\n    (sospechoso e3)\n\n    ; 4) no sospechoso llega a puerta6 \u2192 recogida\n    (esta-en e4 puerta6)\n    (normal e4)\n\n    ; 5) no sospechoso llega a puerta2 \u2192 recogida\n    (esta-en e5 puerta2)\n    (normal e5)\n\n    ; 6) sospechoso llega a puerta2 \u2192 recogida (pasando por inspecci\u00f3n)\n    (esta-en e6 puerta2)\n    (sospechoso e6)\n    )\n\n  (:goal\n    (and\n      ; destinos finales\n      (esta-en e1 puerta4)\n      (esta-en e2 puerta8)\n      (esta-en e3 recogida)\n      (esta-en e4 recogida)\n      (esta-en e5 recogida)\n      (esta-en e6 recogida)\n    )\n  )\n)\n\n", "objects": {"facturacion": "ubicacion", "recogida": "ubicacion", "inspeccion": "ubicacion", "puerta1": "ubicacion", "puerta2": "ubicacion", "puerta3": "ubicacion", "puerta4": "ubicacion", "puerta5": "ubicacion", "puerta6": "ubicacion", "puerta7": "ubicacion", "puerta8": "ubicacion", "m1": "maquina", "m2": "maquina", "v1": "vagon", "v2": "vagon", "v3": "vagon", "v4": "vagon", "v5": "vagon", "e1": "equipaje", "e2": "equipaje", "e3": "equipaje", "e4": "equipaje", "e5": "equipaje", "e6": "equipaje", "n0": "nivel", "n1": "nivel", "n2": "nivel"}, "initialState": {"facturacion": {"type": "ubicacion", "location": null, "container": null, "attachedTo": null, "status": "", "checked": false}, "recogida": {"type": "ubicacion", "location": null, "container": null, "attachedTo": null, "status": "", "checked": false}, "inspeccion": {"type": "ubicacion", "location": null, "container": null, "attachedTo": null, "status": "", "checked": false}, "puerta1": {"type": "ubicacion", "location": null, "container": null, "attachedTo": null, "status": "", "checked": false}, "puerta2": {"type": "ubicacion", "location": null, "container": null, "attachedTo": null, "status": "", "checked": false}, "puerta3": {"type": "ubicacion", "location": null, "container": null, "attachedTo": null, "status": "", "checked": false}, "puerta4": {"type": "ubicacion", "location": null, "container": null, "attachedTo": null, "status": "", "checked": false}, "puerta5": {"type": "ubicacion", "location": null, "container": null, "attachedTo": null, "status": "", "checked": false}, "puerta6": {"type": "ubicacion", "location": null, "container": null, "attachedTo": null, "status": "", "checked": false}, "puerta7": {"type": "ubicacion", "location": null, "container": null, "attachedTo": null, "status": "", "checked": false}, "puerta8": {"type": "ubicacion", "location": null, "container": null, "attachedTo": null, "status": "", "checked": false}, "m1": {"type": "maquina", "location": "recogida", "container": null, "attachedTo": null, "status": "", "checked": false}, "m2": {"type": "maquina", "location": "recogida", "container": null, "attachedTo": null, "status": "", "checked": false}, "v1": {"type": "vagon", "location": "puerta1", "container": null, "attachedTo": null, "status": "", "checked": false}, "v2": {"type": "vagon", "location": "puerta1", "container": null, "attachedTo": null, "status": "", "checked": false}, "v3": {"type": "vagon", "location": "puerta1", "container": null, "attachedTo": null, "status": "", "checked": false}, "v4": {"type": "vagon", "location": "puerta5", "container": null, "attachedTo": null, "status": "", "checked": false}, "v5": {"type": "vagon", "location": "puerta5", "container": null, "attachedTo": null, "status": "", "checked": false}, "e1": {"type": "equipaje", "location": "facturacion", "container": null, "attachedTo": null, "status": "", "checked": false}, "e2": {"type": "equipaje", "location": "facturacion", "container": null, "attachedTo": null, "status": "", "checked": false}, "e3": {"type": "equipaje", "location": "puerta6", "container": null, "attachedTo": null, "status": "", "checked": false}, "e4": {"type": "equipaje", "location": "puerta6", "container": null, "attachedTo": null, "status": "", "checked": false}, "e5": {"type": "equipaje", "location": "puerta2", "container": null, "attachedTo": null, "status": "", "checked": false}, "e6": {"type": "equipaje", "location": "puerta2", "container": null, "attachedTo": null, "status": "", "checked": false}, "n0": {"type": "nivel", "location": null, "container": null, "attachedTo": null, "status": "", "checked": false}, "n1": {"type": "nivel", "location": null, "container": null, "attachedTo": null, "status": "", "checked": false}, "n2": {"type": "nivel", "location": null, "container": null, "attachedTo": null, "status": "", "checked": false}}, "actions": [{"index": 0, "time": 0.0, "name": "mover-maquina", "args": ["m1", "recogida", "facturacion"], "raw": "mover-maquina m1 recogida facturacion"}, {"index": 1, "time": 0.0, "name": "mover-maquina", "args": ["m2", "recogida", "inspeccion"], "raw": "mover-maquina m2 recogida inspeccion"}, {"index": 2, "time": 0.001, "name": "mover-maquina", "args": ["m1", "facturacion", "puerta2"], "raw": "mover-maquina m1 facturacion puerta2"}, {"index": 3, "time": 0.001, "name": "mover-maquina", "args": ["m2", "inspeccion", "puerta1"], "raw": "mover-maquina m2 inspeccion puerta1"}, {"index": 4, "time": 0.002, "name": "enganchar-vagon", "args": ["v1", "m2", "puerta1", "n0"], "raw": "enganchar-vagon v1 m2 puerta1 n0"}, {"index": 5, "time": 0.002, "name": "mover-maquina", "args": ["m1", "puerta2", "puerta4"], "raw": "mover-maquina m1 puerta2 puerta4"}, {"index": 6, "time": 0.003, "name": "mover-maquina", "args": ["m2", "puerta1", "inspeccion"], "raw": "mover-maquina m2 puerta1 inspeccion"}, {"index": 7, "time": 0.003, "name": "mover-maquina", "args": ["m1", "puerta4", "puerta3"], "raw": "mover-maquina m1 puerta4 puerta3"}, {"index": 8, "time": 0.004, "name": "desenganchar-vagon", "args": ["v1", "m2", "inspeccion", "n0"], "raw": "desenganchar-vagon v1 m2 inspeccion n0"}, {"index": 9, "time": 0.004, "name": "mover-maquina", "args": ["m1", "puerta3", "puerta1"], "raw": "mover-maquina m1 puerta3 puerta1"}, {"index": 10, "time": 0.005, "name": "mover-maquina", "args": ["m2", "inspeccion", "puerta5"], "raw": "mover-maquina m2 inspeccion puerta5"}, {"index": 11, "time": 0.005, "name": "enganchar-vagon", "args": ["v2", "m1", "puerta1", "n0"], "raw": "enganchar-vagon v2 m1 puerta1 n0"}, {"index": 12, "time": 0.006, "name": "mover-maquina", "args": ["m1", "puerta1", "inspeccion"], "raw": "mover-maquina m1 puerta1 inspeccion"}, {"index": 13, "time": 0.006, "name": "mover-maquina", "args": ["m2", "puerta5", "puerta7"], "raw": "mover-maquina m2 puerta5 puerta7"}, {"index": 14, "time": 0.007, "name": "mover-maquina", "args": ["m1", "inspeccion", "facturacion"], "raw": "mover-maquina m1 inspeccion facturacion"}, {"index": 15, "time": 0.007, "name": "mover-maquina", "args": ["m2", "puerta7", "puerta8"], "raw": "mover-maquina m2 puerta7 puerta8"}, {"index": 16, "time": 0.008, "name": "cargar-equipaje", "args": ["e2", "v2", "m1", "facturacion", "n0", "n1"], "raw": "cargar-equipaje e2 v2 m1 facturacion n0 n1"}, {"index": 17, "time": 0.008, "name": "mover-maquina", "args": ["m2", "puerta8", "puerta6"], "raw": "mover-maquina m2 puerta8 puerta6"}, {"index": 18, "time": 0.009, "name": "cargar-equipaje", "args": ["e1", "v2", "m1", "facturacion", "n1", "n2"], "raw": "cargar-equipaje e1 v2 m1 facturacion n1 n2"}, {"index": 19, "time": 0.009, "name": "mover-maquina", "args": ["m2", "puerta6", "recogida"], "raw": "mover-maquina m2 puerta6 recogida"}, {"index": 20, "time": 0.01, "name": "mover-maquina", "args": ["m1", "facturacion", "puerta2"], "raw": "mover-maquina m1 facturacion puerta2"}, {"index": 21, "time": 0.01, "name": "mover-maquina", "args": ["m2", "recogida", "inspeccion"], "raw": "mover-maquina m2 recogida inspeccion"}, {"index": 22, "time": 0.011, "name": "descargar-normal", "args": ["e2", "v2", "m1", "puerta2", "n2", "n1"], "raw": "descargar-normal e2 v2 m1 puerta2 n2 n1"}, {"index": 23, "time": 0.011, "name": "enganchar-vagon", "args": ["v1", "m2", "inspeccion", "n0"], "raw": "enganchar-vagon v1 m2 inspeccion n0"}, {"index": 24, "time": 0.012, "name": "mover-maquina", "args": ["m1", "puerta2", "puerta4"], "raw": "mover-maquina m1 puerta2 puerta4"}, {"index": 25, "time": 0.012, "name": "mover-maquina", "args": ["m2", "inspeccion", "facturacion"], "raw": "mover-maquina m2 inspeccion facturacion"}, {"index": 26, "time": 0.013, "name": "descargar-normal", "args": ["e1", "v2", "m1", "puerta4", "n1", "n0"], "raw": "descargar-normal e1 v2 m1 puerta4 n1 n0"}, {"index": 27, "time": 0.013, "name": "mover-maquina", "args": ["m2", "facturacion", "puerta2"], "raw": "mover-maquina m2 facturacion puerta2"}, {"index": 28, "time": 0.014, "name": "cargar-equipaje", "args": ["e6", "v1", "m2", "puerta2", "n0", "n1"], "raw": "cargar-equipaje e6 v1 m2 puerta2 n0 n1"}, {"index": 29, "time": 0.014, "name": "mover-maquina", "args": ["m1", "puerta4", "puerta2"], "raw": "mover-maquina m1 puerta4 puerta2"}, {"index": 30, "time": 0.015, "name": "cargar-equipaje", "args": ["e2", "v1", "m2", "puerta2", "n1", "n2"], "raw": "cargar-equipaje e2 v1 m2 puerta2 n1 n2"}, {"index": 31, "time": 0.015, "name": "cargar-equipaje", "args": ["e5", "v2", "m1", "puerta2", "n0", "n1"], "raw": "cargar-equipaje e5 v2 m1 puerta2 n0 n1"}, {"index": 32, "time": 0.016, "name": "mover-maquina", "args": ["m1", "puerta2", "facturacion"], "raw": "mover-maquina m1 puerta2 facturacion"}, {"index": 33, "time": 0.016, "name": "mover-maquina", "args": ["m2", "puerta2", "facturacion"], "raw": "mover-maquina m2 puerta2 facturacion"}, {"index": 34, "time": 0.017, "name": "mover-maquina", "args": ["m1", "facturacion", "recogida"], "raw": "mover-maquina m1 facturacion recogida"}, {"index": 35, "time": 0.017, "name": "mover-maquina", "args": ["m2", "facturacion", "recogida"], "raw": "mover-maquina m2 facturacion recogida"}, {"index": 36, "time": 0.018, "name": "descargar-normal", "args": ["e5", "v2", "m1", "recogida", "n1", "n0"], "raw": "descargar-normal e5 v2 m1 recogida n1 n0"}, {"index": 37, "time": 0.018, "name": "descargar-normal", "args": ["e2", "v1", "m2", "recogida", "n2", "n1"], "raw": "descargar-normal e2 v1 m2 recogida n2 n1"}, {"index": 38, "time": 0.019, "name": "mover-maquina", "args": ["m1", "recogida", "inspeccion"], "raw": "mover-maquina m1 recogida inspeccion"}, {"index": 39, "time": 0.019, "name": "mover-maquina", "args": ["m2", "recogida", "puerta6"], "raw": "mover-maquina m2 recogida puerta6"}, {"index": 40, "time": 0.02, "name": "mover-maquina", "args": ["m1", "inspeccion", "recogida"], "raw": "mover-maquina m1 inspeccion recogida"}, {"index": 41, "time": 0.02, "name": "cargar-equipaje", "args": ["e3", "v1", "m2", "puerta6", "n1", "n2"], "raw": "cargar-equipaje e3 v1 m2 puerta6 n1 n2"}, {"index": 42, "time": 0.021, "name": "mover-maquina", "args": ["m2", "puerta6", "recogida"], "raw": "mover-maquina m2 puerta6 recogida"}, {"index": 43, "time": 0.021, "name": "cargar-equipaje", "args": ["e2", "v2", "m1", "recogida", "n0", "n1"], "raw": "cargar-equipaje e2 v2 m1 recogida n0 n1"}, {"index": 44, "time": 0.022, "name": "mover-maquina", "args": ["m1", "recogida", "puerta6"], "raw": "mover-maquina m1 recogida puerta6"}, {"index": 45, "time": 0.022, "name": "mover-maquina", "args": ["m2", "recogida", "inspeccion"], "raw": "mover-maquina m2 recogida inspeccion"}, {"index": 46, "time": 0.023, "name": "cargar-equipaje", "args": ["e4", "v2", "m1", "puerta6", "n1", "n2"], "raw": "cargar-equipaje e4 v2 m1 puerta6 n1 n2"}, {"index": 47, "time": 0.023, "name": "inspeccionar-equipaje", "args": ["e6", "inspeccion", "v1", "m2"], "raw": "inspeccionar-equipaje e6 inspeccion v1 m2"}, {"index": 48, "time": 0.023, "name": "inspeccionar-equipaje", "args": ["e3", "inspeccion", "v1", "m2"], "raw": "inspeccionar-equipaje e3 inspeccion v1 m2"}, {"index": 49, "time": 0.024, "name": "mover-maquina", "args": ["m2", "inspeccion", "recogida"], "raw": "mover-maquina m2 inspeccion recogida"}, {"index": 50, "time": 0.024, "name": "mover-maquina", "args": ["m1", "puerta6", "puerta8"], "raw": "mover-maquina m1 puerta6 puerta8"}, {"index": 51, "time": 0.025, "name": "descargar-normal", "args": ["e6", "v1", "m2", "recogida", "n2", "n1"], "raw": "descargar-normal e6 v1 m2 recogida n2 n1"}, {"index": 52, "time": 0.025, "name": "descargar-normal", "args": ["e2", "v2", "m1", "puerta8", "n2", "n1"], "raw": "descargar-normal e2 v2 m1 puerta8 n2 n1"}, {"index": 53, "time": 0.026, "name": "mover-maquina", "args": ["m1", "puerta8", "puerta6"], "raw": "mover-maquina m1 puerta8 puerta6"}, {"index": 54, "time": 0.026, "name": "descargar-normal", "args": ["e3", "v1", "m2", "recogida", "n1", "n0"], "raw": "descargar-normal e3 v1 m2 recogida n1 n0"}, {"index": 55, "time": 0.027, "name": "mover-maquina", "args": ["m1", "puerta6", "recogida"], "raw": "mover-maquina m1 puerta6 recogida"}, {"index": 56, "time": 0.028, "name": "descargar-normal", "args": ["e4", "v2", "m1", "recogida", "n1", "n0"], "raw": "descargar-normal e4 v2 m1 recogida n1 n0"}]};

let actions = payload.actions;
let baseState = normalizeState(payload.initialState);
let currentPlanName = payload.planFile;
let currentProblemName = payload.problemFile;
let currentStep = -1;
let problemText = payload.problemText || '';
let planText = payload.planText || '';
let staticLiterals = payload.staticLiterals || [];
const loadedPlans = new Map();

if(staticLiterals.length === 0 && payload.problemText){
  const parsed = parseInitialStateJS(payload.problemText, payload.objects);
  payload.initialState = parsed.state;
  payload.staticLiterals = parsed.staticLiterals;
  staticLiterals = payload.staticLiterals;
  baseState = normalizeState(payload.initialState);
}

function normalizeState(state){
  const st = cloneState(state);
  Object.entries(st).forEach(([name,obj])=>{
    if(!obj.location && obj.attachedTo && st[obj.attachedTo]){
      obj.location = st[obj.attachedTo].location || null;
    }
    if(!obj.location && obj.container && st[obj.container]){
      obj.location = st[obj.container].location || null;
    }
  });
  return st;
}

function locationFor(objName, state){
  const obj = state[objName];
  if(!obj) return null;
  if(obj.location) return obj.location;
  if(obj.attachedTo && state[obj.attachedTo]) return locationFor(obj.attachedTo, state);
  if(obj.container && state[obj.container]) return locationFor(obj.container, state);
  return null;
}

function cloneState(state){
  return JSON.parse(JSON.stringify(state));
}

function computeState(upTo){
  let st = cloneState(baseState);
  for(let i=0;i<=upTo && i<actions.length;i++){
    applyAction(st, actions[i]);
  }
  return st;
}

function stateToLiterals(state){
  const literals = new Set(staticLiterals);
  Object.entries(state).forEach(([name, obj])=>{
    if(obj.location){ literals.add(`esta-en ${name} ${obj.location}`); }
    if(obj.attachedTo){ literals.add(`enganchado ${name} ${obj.attachedTo}`); }
    if(obj.container){ literals.add(`en-contenedor ${name} ${obj.container}`); }
    if(obj.status){ literals.add(`${obj.status} ${name}`); }
    if(obj.checked){ literals.add(`inspeccionado ${name}`); }
  });
  return [...literals].sort();
}

function applyAction(st, action){
  const [type, ...rest] = [action.name, ...action.args];
  const lower = type.toLowerCase();
  if(lower.startsWith('mover-maquina')){
    const [machine, , to] = rest;
    if(st[machine]){
      st[machine].location = to;
      for(const obj of Object.values(st)){
        if(obj.attachedTo === machine){
          obj.location = to;
        }
      }
    }
  } else if(lower.startsWith('enganchar-vagon')){
    const [vagon, target] = rest;
    if(st[vagon]){
      st[vagon].attachedTo = target;
      if(st[target] && st[target].location){
        st[vagon].location = st[target].location;
      }
    }
  } else if(lower.startsWith('desenganchar-vagon')){
    const [vagon] = rest;
    if(st[vagon]){
      st[vagon].attachedTo = null;
    }
  } else if(lower.startsWith('cargar-equipaje')){
    const [equipaje, vagon] = rest;
    if(st[equipaje]){
      st[equipaje].container = vagon;
      st[equipaje].location = null;
    }
  } else if(lower.startsWith('descargar')){
    const [equipaje, , , destino] = rest;
    if(st[equipaje]){
      st[equipaje].container = null;
      st[equipaje].location = destino;
    }
  } else if(lower.startsWith('inspeccionar-equipaje')){
    const [equipaje, lugar] = rest;
    if(st[equipaje]){
      st[equipaje].checked = true;
      st[equipaje].inspectedAt = lugar;
    }
  }
}

function drawMap(svg){
  svg.innerHTML = '';
  edges.forEach(([a,b])=>{
    const na = nodes[a];
    const nb = nodes[b];
    const road = document.createElementNS('http://www.w3.org/2000/svg','line');
    road.setAttribute('x1', na.x);
    road.setAttribute('y1', na.y);
    road.setAttribute('x2', nb.x);
    road.setAttribute('y2', nb.y);
    road.setAttribute('class','road');
    svg.appendChild(road);

    const dash = document.createElementNS('http://www.w3.org/2000/svg','line');
    dash.setAttribute('x1', na.x);
    dash.setAttribute('y1', na.y);
    dash.setAttribute('x2', nb.x);
    dash.setAttribute('y2', nb.y);
    dash.setAttribute('class','road-dash');
    svg.appendChild(dash);
  });
  Object.entries(nodes).forEach(([name,info])=>{
    const rect = document.createElementNS('http://www.w3.org/2000/svg','rect');
    rect.setAttribute('x', info.x - 60);
    rect.setAttribute('y', info.y - 30);
    rect.setAttribute('width', 120);
    rect.setAttribute('height', 60);
    rect.setAttribute('rx', 8);
    rect.setAttribute('class','node');
    svg.appendChild(rect);

    const label = document.createElementNS('http://www.w3.org/2000/svg','text');
    label.setAttribute('x', info.x);
    label.setAttribute('y', info.y);
    label.setAttribute('text-anchor', 'middle');
    label.setAttribute('class','node-label');
    label.textContent = info.label;
    svg.appendChild(label);
  });
}

function renderTokens(svg, state){
  const perLocation = {};
  Object.entries(state).forEach(([name,obj])=>{
    const loc = locationFor(name, state);
    if(!loc || !nodes[loc]) return;
    if(!perLocation[loc]) perLocation[loc] = {machines:[], vagones:[], equipajes:[]};
    if(obj.type === 'maquina') perLocation[loc].machines.push({name,obj});
    else if(obj.type === 'vagon') perLocation[loc].vagones.push({name,obj});
    else if(obj.type === 'equipaje') perLocation[loc].equipajes.push({name,obj});
  });

  const machinePositions = new Map();
  const wagonPositions = new Map();
  const drawnWagons = new Set();

  function slot(baseX, total, idx, spacing=130){
    return baseX + (idx - (total-1)/2) * spacing;
  }

  function drawMachine(x,y,label){
    const group = document.createElementNS('http://www.w3.org/2000/svg','g');
    const body = document.createElementNS('http://www.w3.org/2000/svg','rect');
    body.setAttribute('x', x-28); body.setAttribute('y', y-22);
    body.setAttribute('width', 56); body.setAttribute('height', 28);
    body.setAttribute('rx', 8); body.setAttribute('class','machine-body');
    group.appendChild(body);
    const cabin = document.createElementNS('http://www.w3.org/2000/svg','rect');
    cabin.setAttribute('x', x-12); cabin.setAttribute('y', y-32);
    cabin.setAttribute('width', 22); cabin.setAttribute('height', 12);
    cabin.setAttribute('rx', 4); cabin.setAttribute('class','machine-cabin');
    group.appendChild(cabin);
    [ -16, 16].forEach(offset=>{
      const wheel = document.createElementNS('http://www.w3.org/2000/svg','circle');
      wheel.setAttribute('cx', x+offset);
      wheel.setAttribute('cy', y+6);
      wheel.setAttribute('r', 5);
      wheel.setAttribute('class','wheel');
      group.appendChild(wheel);
    });
    const text = document.createElementNS('http://www.w3.org/2000/svg','text');
    text.setAttribute('x', x);
    text.setAttribute('y', y-24);
    text.setAttribute('text-anchor','middle');
    text.setAttribute('class','entity-label');
    text.textContent = label.toUpperCase();
    group.appendChild(text);
    svg.appendChild(group);
  }

  function drawWagon(x,y,label){
    const group = document.createElementNS('http://www.w3.org/2000/svg','g');
    const body = document.createElementNS('http://www.w3.org/2000/svg','rect');
    body.setAttribute('x', x-28); body.setAttribute('y', y-18);
    body.setAttribute('width', 56); body.setAttribute('height', 24);
    body.setAttribute('rx', 4); body.setAttribute('class','wagon-body');
    group.appendChild(body);
    const top = document.createElementNS('http://www.w3.org/2000/svg','rect');
    top.setAttribute('x', x-24); top.setAttribute('y', y-26);
    top.setAttribute('width', 48); top.setAttribute('height', 10);
    top.setAttribute('rx', 4); top.setAttribute('class','wagon-top');
    group.appendChild(top);
    [-16, 16].forEach(offset=>{
      const wheel = document.createElementNS('http://www.w3.org/2000/svg','circle');
      wheel.setAttribute('cx', x+offset);
      wheel.setAttribute('cy', y+6);
      wheel.setAttribute('r', 5);
      wheel.setAttribute('class','wheel');
      group.appendChild(wheel);
    });
    const text = document.createElementNS('http://www.w3.org/2000/svg','text');
    text.setAttribute('x', x);
    text.setAttribute('y', y-18);
    text.setAttribute('text-anchor','middle');
    text.setAttribute('class','entity-label');
    text.textContent = label.toUpperCase();
    group.appendChild(text);
    svg.appendChild(group);
  }

  function drawBag(x,y,label,status,checked){
    const group = document.createElementNS('http://www.w3.org/2000/svg','g');
    group.setAttribute('class', `bag ${status || 'normal'} ${checked ? 'checked' : ''}`.trim());
    const body = document.createElementNS('http://www.w3.org/2000/svg','rect');
    body.setAttribute('x', x-12); body.setAttribute('y', y-12);
    body.setAttribute('width', 24); body.setAttribute('height', 18);
    body.setAttribute('rx', 4); body.setAttribute('class','bag-body');
    group.appendChild(body);
    const handle = document.createElementNS('http://www.w3.org/2000/svg','path');
    handle.setAttribute('d', `M ${x-6} ${y-12} Q ${x} ${y-18} ${x+6} ${y-12}`);
    handle.setAttribute('class','bag-handle');
    group.appendChild(handle);
    const text = document.createElementNS('http://www.w3.org/2000/svg','text');
    text.setAttribute('x', x);
    text.setAttribute('y', y+18);
    text.setAttribute('text-anchor','middle');
    text.setAttribute('class','entity-label');
    text.textContent = label.toUpperCase();
    group.appendChild(text);
    svg.appendChild(group);
  }

  Object.entries(perLocation).forEach(([loc, groups])=>{
    const base = nodes[loc];
    const baseLineY = base.y + 20;
    const bagLineY = base.y - 6;
    const wagonSpacing = 70;
    groups.machines.forEach((entry, idx)=>{
      const x = slot(base.x, groups.machines.length, idx, 130);
      drawMachine(x, baseLineY, entry.name);
      machinePositions.set(entry.name, {x, y: baseLineY});
      const drawChain = (anchorName, anchorX)=>{
        const attached = groups.vagones.filter(v=>v.obj.attachedTo === anchorName);
        attached.forEach((wag, widx)=>{
          const wx = anchorX + (widx+1)*wagonSpacing;
          drawWagon(wx, baseLineY, wag.name);
          wagonPositions.set(wag.name, {x: wx, y: baseLineY});
          drawnWagons.add(wag.name);
          const line = document.createElementNS('http://www.w3.org/2000/svg','line');
          line.setAttribute('x1', anchorX);
          line.setAttribute('y1', baseLineY);
          line.setAttribute('x2', wx);
          line.setAttribute('y2', baseLineY);
          line.setAttribute('class','connection-line');
          svg.appendChild(line);
          drawChain(wag.name, wx);
        });
      };
      drawChain(entry.name, x);
    });

    const freeWagons = groups.vagones.filter(v=>!drawnWagons.has(v.name));
    freeWagons.forEach((wag, idx)=>{
      const wx = slot(base.x, freeWagons.length, idx, 110);
      const wy = baseLineY;
      drawWagon(wx, wy, wag.name);
      wagonPositions.set(wag.name, {x: wx, y: wy});
    });

    const looseBags = groups.equipajes.filter(b=>!b.obj.container);
    looseBags.forEach((bag, idx)=>{
      const bx = slot(base.x, looseBags.length, idx, 70);
      const by = bagLineY;
      drawBag(bx, by, bag.name, bag.obj.status, bag.obj.checked);
    });
  });

  Object.entries(state).forEach(([name,obj])=>{
    if(obj.type !== 'equipaje' || !obj.container) return;
    const hostPos = wagonPositions.get(obj.container) || machinePositions.get(obj.container);
    if(!hostPos) return;
    const siblings = Object.entries(state).filter(([n,o])=> o.type==='equipaje' && o.container === obj.container);
    const idx = siblings.findIndex(([n])=> n===name);
    const bx = hostPos.x + (idx - (siblings.length-1)/2)*18;
    const by = hostPos.y - 22;
    drawBag(bx, by, name, obj.status, obj.checked);
  });
}

  function renderLiterals(state, previousState){
    const list = document.getElementById('literalList');
    const changes = document.getElementById('literalChanges');
    list.innerHTML = '';
  changes.innerHTML = '';
  const current = stateToLiterals(state);
  const prev = previousState ? new Set(stateToLiterals(previousState)) : new Set();
  const currentSet = new Set(current);
  const added = current.filter(lit => !prev.has(lit));
  const removed = [...prev].filter(lit => !currentSet.has(lit));

  current.forEach(lit=>{
    const li = document.createElement('li');
    if(prev.size === 0 || added.includes(lit)){
      li.className = 'literal-added';
    }
    li.textContent = lit;
    list.appendChild(li);
  });

  if(added.length === 0 && removed.length === 0){
    const li = document.createElement('li');
    li.textContent = 'Sin cambios en esta acción';
    changes.appendChild(li);
    return;
  }

  added.forEach(lit=>{
    const li = document.createElement('li');
    li.className = 'literal-added';
    li.textContent = `+ ${lit}`;
    changes.appendChild(li);
  });
  removed.forEach(lit=>{
    const li = document.createElement('li');
    li.className = 'literal-removed';
    li.textContent = `- ${lit}`;
    changes.appendChild(li);
  });
}

function populateLog(log){
  const initial = document.createElement('li');
  initial.id = 'action--1';
  initial.textContent = 'Estado inicial (máquinas, vagones y equipajes)';
  log.appendChild(initial);
  actions.forEach((act)=>{
    const li = document.createElement('li');
    li.id = `action-${act.index}`;
    li.textContent = `${act.index}. ${act.raw}`;
    log.appendChild(li);
  });
}

function update(step){
  const svg = document.getElementById('map');
  drawMap(svg);
  const state = computeState(step);
  const previous = step <= -1 ? null : computeState(step-1);
  renderTokens(svg, state);
  renderLiterals(state, previous);
  document.getElementById('status').textContent = step < 0 ? 'Estado inicial' : `Acción ${step + 1} / ${actions.length}`;
  document.querySelectorAll('.action-log li').forEach(li=>li.classList.remove('active'));
  const active = document.getElementById(`action-${step}`);
  if(active){ active.classList.add('active'); active.scrollIntoView({behavior:'smooth', block:'center'}); }
  document.getElementById('back').disabled = step <= -1;
  document.getElementById('next').disabled = step >= actions.length -1;
}

function init(){
  const log = document.getElementById('log');
  populateLog(log);
  currentStep = -1;
  let timer = null;
  update(currentStep);
  const back = document.getElementById('back');
  const next = document.getElementById('next');
  const play = document.getElementById('play');
  const planSelect = document.getElementById('planSelect');
  const folderInput = document.getElementById('folderInput');
  const planInput = document.getElementById('planInput');
  const problemInput = document.getElementById('problemInput');
  const useLoaded = document.getElementById('useLoaded');
  const gifStart = document.getElementById('gifStart');
  const gifEnd = document.getElementById('gifEnd');
  const downloadGif = document.getElementById('downloadGif');
  const gifStatus = document.getElementById('gifStatus');

  planSelect.innerHTML = '';
  const baseOpt = document.createElement('option');
  baseOpt.value = '__initial__';
  baseOpt.textContent = currentPlanName || 'Plan inicial';
  planSelect.appendChild(baseOpt);
  refreshActionRangeOptions(gifStart, gifEnd);

  back.addEventListener('click', ()=>{
    currentStep = Math.max(-1, currentStep-1);
    update(currentStep);
  });
  next.addEventListener('click', ()=>{
    currentStep = Math.min(actions.length-1, currentStep+1);
    update(currentStep);
  });
  play.addEventListener('click', ()=>{
    if(timer){
      clearInterval(timer); timer = null; play.textContent='▶️ Reproducir';
      return;
    }
    play.textContent = '⏸️ Pausar';
    timer = setInterval(()=>{
      if(currentStep >= actions.length -1){
        clearInterval(timer); timer=null; play.textContent='▶️ Reproducir'; return;
      }
      currentStep +=1;
      update(currentStep);
    }, 900);
  });

  folderInput.addEventListener('change', async (ev)=>{
    await cacheFiles(ev.target.files);
    refreshPlanSelect(planSelect);
  });
  planInput.addEventListener('change', async (ev)=>{
    await cacheFiles(ev.target.files);
    refreshPlanSelect(planSelect);
  });
  problemInput.addEventListener('change', async (ev)=>{
    const files = ev.target.files;
    if(files && files[0]){
      problemText = await files[0].text();
      currentProblemName = files[0].name;
    }
  });
  downloadGif.addEventListener('click', async ()=>{
    const start = parseInt(gifStart.value, 10);
    const end = parseInt(gifEnd.value, 10);
    if(Number.isNaN(start) || Number.isNaN(end)){
      alert('Selecciona un rango válido de acciones.');
      return;
    }
    if(start > end){
      alert('El paso inicial debe ser anterior o igual al final.');
      return;
    }
    downloadGif.disabled = true;
    gifStatus.textContent = 'Preparando fotogramas...';
    try {
      await exportGif(start, end, gifStatus);
    } catch(err){
      alert('No se pudo generar el GIF: ' + err.message);
    } finally {
      downloadGif.disabled = false;
      gifStatus.textContent = '';
    }
  });
  useLoaded.addEventListener('click', async ()=>{
    const selectedKey = planSelect.value;
    if(selectedKey === '__initial__'){
      applyPayload(payload);
      return;
    }
    const record = loadedPlans.get(selectedKey);
    if(!record){ return; }
    if(!problemText){
      alert('Carga antes un fichero de problema .pddl para poder interpretar el plan.');
      return;
    }
    const newPayload = buildPayloadFromTexts(record.text, problemText, record.name, currentProblemName || 'problema.pddl');
    applyPayload(newPayload);
  });
}

function applyPayload(pl){
  actions = pl.actions;
  baseState = normalizeState(pl.initialState);
  staticLiterals = pl.staticLiterals || [];
  if(staticLiterals.length === 0 && pl.problemText){
    const parsed = parseInitialStateJS(pl.problemText, pl.objects);
    baseState = normalizeState(parsed.state);
    staticLiterals = parsed.staticLiterals;
  }
  currentPlanName = pl.planFile;
  currentProblemName = pl.problemFile;
  planText = pl.planText || planText;
  problemText = pl.problemText || problemText;
  document.querySelector('header p').textContent = `Plan: ${currentPlanName} | Problema: ${currentProblemName}`;
  document.getElementById('log').innerHTML = '';
  populateLog(document.getElementById('log'));
  refreshActionRangeOptions(document.getElementById('gifStart'), document.getElementById('gifEnd'));
  currentStep = -1;
  update(currentStep);
}

async function cacheFiles(fileList){
  for(const file of fileList){
    const text = await file.text();
    const key = file.webkitRelativePath || file.name;
    loadedPlans.set(key, {name: file.name, text});
    if(!problemText && file.name.toLowerCase().endsWith('.pddl')){
      problemText = text;
      currentProblemName = file.name;
    }
  }
}

function refreshPlanSelect(select){
  const previous = select.value;
  select.innerHTML = '';
  const baseOpt = document.createElement('option');
  baseOpt.value = '__initial__';
  baseOpt.textContent = currentPlanName || 'Plan inicial';
  select.appendChild(baseOpt);
  [...loadedPlans.entries()]
    .filter(([key, rec])=> rec.name.match(/\.soln?$|\.plan$|\.txt$/i))
    .forEach(([key, rec])=>{
      const opt = document.createElement('option');
      opt.value = key;
      opt.textContent = rec.name;
      select.appendChild(opt);
    });
  if([...select.options].some(opt=>opt.value === previous)){
    select.value = previous;
  }
}

function buildPayloadFromTexts(planTxt, problemTxt, planName, problemName){
  const objects = parseObjectsJS(problemTxt);
  const { state: initialState, staticLiterals: parsedStaticLiterals } = parseInitialStateJS(problemTxt, objects);
  const acts = parsePlanJS(planTxt);
  return {
    planFile: planName,
    problemFile: problemName,
    planText: planTxt,
    problemText: problemTxt,
    objects,
    initialState,
    staticLiterals: parsedStaticLiterals,
    actions: acts,
  };
}

function parseObjectsJS(problemText){
  const objects = {};
  const match = problemText.match(/\(:objects([\s\S]*?)\)/i);
  if(!match){ return objects; }
  const block = match[1];
  const tokens = block
    .split(/\s+/)
    .map(t=>t.trim())
    .filter(Boolean);
  let buffer = [];
  let currentType = null;
  for(let idx=0; idx<tokens.length; idx++){
    const tok = tokens[idx];
    if(tok === '-'){
      currentType = tokens[idx+1];
      buffer.forEach(name=> objects[name] = currentType || 'object');
      buffer = [];
      idx +=1;
    } else {
      buffer.push(tok);
    }
  }
  buffer.forEach(name=> objects[name] = currentType || 'object');
  return objects;
}

function parseInitialStateJS(problemText, objects){
  const initialState = {};
  const staticFacts = new Set();
  Object.entries(objects).forEach(([name, type])=>{
    initialState[name] = {type, location: null, container: null, attachedTo: null, status: '', checked: false};
  });
  const initMatch = problemText.match(/\(:init([\s\S]*?)\)\s*\(:goal/i);
  if(!initMatch){ return {state: initialState, staticLiterals: []}; }
  const block = initMatch[1];
  block.split(/\n/).forEach(line=>{
    const clean = line.split(';')[0].trim();
    if(!clean){ return; }
    const fact = clean.replace(/[()]/g,'').trim().split(/\s+/);
    if(fact.length < 2){ return; }
    const [pred, subj, target] = fact;
    const entry = initialState[subj];
    if(pred === 'esta-en' && entry && target){ entry.location = target; }
    else if(pred === 'enganchado' && entry && target){ entry.attachedTo = target; }
    else if(pred === 'sospechoso' && entry){ entry.status = 'sospechoso'; staticFacts.add(`sospechoso ${subj}`); }
    else if(pred === 'normal' && entry){ entry.status = 'normal'; staticFacts.add(`normal ${subj}`); }
    else if(pred !== 'siguiente'){ staticFacts.add(fact.join(' ')); }
  });
  return {state: initialState, staticLiterals: [...staticFacts].sort()};
}

function parsePlanJS(planText){
  const actions = [];
  const regex = /\s*([\d\.]+):\s*\(([^\)]+)\)/g;
  let match;
  while((match = regex.exec(planText)) !== null){
    const raw = match[2].trim();
    const parts = raw.toLowerCase().split(/\s+/);
    actions.push({index: actions.length, time: parseFloat(match[1]), name: parts[0], args: parts.slice(1), raw});
  }
  return actions;
}

function refreshActionRangeOptions(startSelect, endSelect){
  if(!startSelect || !endSelect) return;
  const options = [];
  for(let i=-1; i<actions.length; i++){
    const label = i < 0 ? 'Estado inicial' : `Acción ${i+1}`;
    options.push({value: i, label});
  }
  [startSelect, endSelect].forEach((sel, idx)=>{
    const previous = parseInt(sel.value, 10);
    sel.innerHTML = '';
    options.forEach(optData=>{
      const opt = document.createElement('option');
      opt.value = optData.value;
      opt.textContent = optData.label;
      sel.appendChild(opt);
    });
    const fallback = idx === 0 ? -1 : actions.length -1;
    sel.value = Number.isNaN(previous) ? fallback : previous;
    if(sel.value === '') sel.value = fallback;
  });
}

function renderFrameCanvas(step){
  return new Promise((resolve, reject)=>{
    const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
    svg.setAttribute('xmlns','http://www.w3.org/2000/svg');
    svg.setAttribute('viewBox','0 0 1040 660');
    svg.setAttribute('width','1040');
    svg.setAttribute('height','660');
    drawMap(svg);
    const frameState = computeState(step);
    renderTokens(svg, frameState);
    const serializer = new XMLSerializer();
    const svgString = serializer.serializeToString(svg);
    const img = new Image();
    img.onload = ()=>{
      const canvas = document.createElement('canvas');
      canvas.width = 1040;
      canvas.height = 660;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#fdfefe';
      ctx.fillRect(0,0,canvas.width, canvas.height);
      ctx.drawImage(img, 0, 0);
      resolve(canvas);
    };
    img.onerror = ()=> reject(new Error('No se pudo rasterizar el plano.'));
    img.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgString);
  });
}

let cachedWorkerUrl = null;
async function getWorkerUrl(){
  if(cachedWorkerUrl){ return cachedWorkerUrl; }
  const remoteUrl = 'https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.worker.js';
  try {
    const response = await fetch(remoteUrl);
    if(!response.ok){ throw new Error('Respuesta no válida del CDN'); }
    const code = await response.text();
    cachedWorkerUrl = URL.createObjectURL(new Blob([code], {type:'application/javascript'}));
    return cachedWorkerUrl;
  } catch(err){
    throw new Error('No se pudo obtener el worker de GIF.js. Comprueba la conexión o descarga el fichero localmente.');
  }
}

async function exportGif(start, end, statusEl){
  const workerUrl = await getWorkerUrl();
  const gif = new GIF({
    workers: 2,
    quality: 10,
    width: 1040,
    height: 660,
    workerScript: workerUrl,
  });
  const delay = 900;
  for(let step=start; step<=end; step++){
    if(statusEl){ statusEl.textContent = `Renderizando paso ${step+1}/${end+1}`; }
    const canvas = await renderFrameCanvas(step);
    gif.addFrame(canvas, {delay});
  }
  return new Promise((resolve, reject)=>{
    gif.on('finished', (blob)=>{
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const planSlug = (currentPlanName || 'plan').replace(/\s+/g,'-');
      a.download = `${planSlug}_acciones_${start+1}-${end+1}.gif`;
      a.click();
      URL.revokeObjectURL(url);
      resolve();
    });
    gif.on('abort', ()=> reject(new Error('Proceso cancelado.')));
    gif.on('error', (err)=> reject(err));
    if(statusEl){ statusEl.textContent = 'Generando GIF...'; }
    gif.render();
  });
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>